<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>

    <div class="filter-container">
      <div id="layout-filters">
        Layout:
        <label>Range  <input type="radio" name="layout" value="range"  onclick="filter(this);" checked="checked"></label>
        <label>Scatterplot <input type="radio" name="layout" value="scatterplot" onclick="filter(this);"></label>   
        <br/>          
      </div>
      <div id="range-filters">
        Spacing:
          <label>Equal  <input type="radio" name="scale" value="equal"  onclick="filter(this);" checked="checked"></label>
          <label>Linear <input type="radio" name="scale" value="linear" onclick="filter(this);"></label>   
          <br/>  
        Filter:
          <select id="dimension" onchange="filter(this)">
            <option value="population">population</option>
            <option value="gdp">gdp</option>
            <option value="life_expectancy">life expectancy</option>   
          </select>  
      </div>
      <div id="scatterplot-filters">
        <label>Population/GDP  <input type="radio" name="plot" value="pop"  onclick="filter(this);" checked="checked"></label>
        <label>Lat/Long <input type="radio" name="plot" value="lat" onclick="filter(this);"></label>           
      </div>
    </div>

    <div class="container">
    </div>

  <script type="text/javascript">


    // load data
    var raw_data     = new Array();
    var years        = new Array();
    var current_data = new Array();

    d3.json("data/countries_1995_2012.json", function(error, data){


        // transform the data into a flat format that we can more easily use
        for (i in data) {
          for (y in data[i].years) {
              // create a new record: name, continent, 
              // gdp, life_expectancy, population, year
              var record = {
                            'name'            : data[i].name,
                            'latitude'        : data[i].latitude,
                            'longitude'       : data[i].longitude,                                                        
                            'continent'       : data[i].continent,
                            'gdp'             : data[i].years[y].gdp,
                            'life_expectancy' : data[i].years[y].life_expectancy,
                            'population'      : data[i].years[y].population,
                            'year'            : data[i].years[y].year
                           };
              raw_data.push(record);

              // push years into an array to determin min/max
              years.push(data[i].years[y].year);

              // create an array of initial data by year (1995 to start)
              if (data[i].years[y].year == '2012') {
                current_data.push(record);
              }
          }
        }

        update_svg(current_data);
    });


    function filter(x) {

      d3.selectAll("input").each(function(d) { 
        if (d3.select(this).attr("type") == "radio" && d3.select(this).attr("name") == "layout" && d3.select(this).node().checked) {
          layout_value = d3.select(this).attr("value");
        }
      });
      console.log('layout_value: ' + layout_value);
      var r = document.getElementById('range-filters');
      var s = document.getElementById('scatterplot-filters');  

      if (layout_value == 'range') {
        r.style.display = 'inline'; 
        s.style.display = 'none';
        range();
      }
      else if (layout_value == 'scatterplot') {
        r.style.display = 'none'; 
        s.style.display = 'inline';
        scatter();
      }

    }

    function scatter() {
      // get filter values from form elements
      // :: scale

      var plot_value = "";
      d3.selectAll("input").each(function(d) { 
        if (d3.select(this).attr("type") == "radio" && d3.select(this).attr("name") == "plot" && d3.select(this).node().checked) {
          plot_value = d3.select(this).attr("value");
        }
      });

      if (plot_value == 'pop') {
             
        y_max = d3.max(current_data, function(d) { return d.population; });
        y_min = d3.min(current_data, function(d) { return d.population; });    

        x_max = d3.max(current_data, function(d) { return d.gdp; });
        x_min = d3.min(current_data, function(d) { return d.gdp; });            


        var yScale = d3.scale.linear();
        yScale.domain([y_max, y_min]);
        yScale.range([10, 1800]);

        var xScale = d3.scale.linear();
        xScale.domain([x_min, x_max]);
        xScale.range([10, 2000]);

   
          d3.selectAll("circle")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('cy', d3.round(yScale(d.population)- 4))
                .attr('cx', d3.round(xScale(d.gdp)));
            });

          d3.selectAll("text")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('y', d3.round(yScale(d.population)))
                .attr('x', d3.round(xScale(d.gdp) + 10));
            });
      }
      else if (plot_value == 'lat') {
             
          y_max = d3.max(current_data, function(d) { return d.latitude; });
          y_min = d3.min(current_data, function(d) { return d.latitude; });    

          x_max = d3.max(current_data, function(d) { return d.longitude; });
          x_min = d3.min(current_data, function(d) { return d.longitude; });            


        var yScale = d3.scale.linear();
        yScale.domain([y_max, y_min]);
        yScale.range([10, 1800]);

        var xScale = d3.scale.linear();
        xScale.domain([x_min, x_max]);
        xScale.range([10, 2000]);

  
          d3.selectAll("circle")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('cy', d3.round(yScale(d.latitude)- 4))
                .attr('cx', d3.round(xScale(d.longitude)));
            });

          d3.selectAll("text")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('y', d3.round(yScale(d.latitude)))
                .attr('x', d3.round(xScale(d.longitude) + 10));
            });          
      }    
    }

    function range() {
      // get filter values from form elements
      // :: scale

      d3.selectAll("input").each(function(d) { 
        if (d3.select(this).attr("type") == "radio" && d3.select(this).attr("name") == "scale" && d3.select(this).node().checked) {
          radio_value = d3.select(this).attr("value");
        }
      });

      // :: dimension
      dimension_value = d3.select("#dimension").node().value; 
      if (radio_value == 'linear') {

        // set domain and range for linear transformation   
        if (dimension_value == 'population') {              
          max = d3.max(current_data, function(d) { return d.population; });
          min = d3.min(current_data, function(d) { return d.population; });    
        }
        else if (dimension_value == 'gdp') {
          max = d3.max(current_data, function(d) { return d.gdp; });
          min = d3.min(current_data, function(d) { return d.gdp; }); 
        } 
        else if (dimension_value == 'life_expectancy') {
          max = d3.max(current_data, function(d) { /* console.log('sanity: ' + d.life_expectancy); */ return d.life_expectancy; });
          min = d3.min(current_data, function(d) { return d.life_expectancy; });           
        } 
        var yScale = d3.scale.linear();
        yScale.domain([max, min]);
        yScale.range([10, 1800]);

        if (dimension_value == 'population') {   
          d3.selectAll("circle")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('cx', 0)
                .attr('cy', d3.round(yScale(d.population)- 4));
            });

          d3.selectAll("text")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('x', 20)                
                .attr('y', d3.round(yScale(d.population)));
            });
        }
        else if (dimension_value=='gdp') {
          d3.selectAll("circle")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('cx', 0)
                .attr('cy', d3.round(yScale(d.gdp)- 4));
            });

          d3.selectAll("text")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('x', 20)
                .attr('y', d3.round(yScale(d.gdp)));
            });
        }  
        else if (dimension_value=='life_expectancy') {
          d3.selectAll("circle")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('cx', 0)
                .attr('cy', d3.round(yScale(d.life_expectancy)- 4));
            });

          d3.selectAll("text")
            .each(function(d) {
              d3.select(this)
                .transition()
                .attr('x', 20)
                .attr('y', d3.round(yScale(d.life_expectancy)));
            });
        }  

      }
      else if (radio_value == 'equal') {
        // set domain and range for ordinal transformation
        var yScale = d3.scale.ordinal().rangeRoundBands([0, current_data.length*15], .8, 0); 

        sorted_data = current_data;
        if (dimension_value == 'population') {
           sorted_data.sort(function(a, b) {
                  var x = a.population;
                  var y = b.population;
                  return y - x;
           });
        }
        else if (dimension_value == 'gdp') {
           sorted_data.sort(function(a, b) {
                  var x = a.gdp;
                  var y = b.gdp;
                  return y - x;
           });
        }
        else if (dimension_value == 'life_expectancy') {
           sorted_data.sort(function(a, b) {
                  var x = a.life_expectancy;
                  var y = b.life_expectancy;
                  return y - x;
           });
        }        
        yScale.domain(sorted_data.map(function(d) { return d.name; }));

        d3.selectAll("circle")
          .each(function(d) {
            d3.select(this)
              .transition()
              .attr('cx', 0)
              .attr('cy', yScale(d.name));
          });

        d3.selectAll("text")
          .each(function(d) {
            d3.select(this)
              .transition()
              .attr('x', 20)
              .attr('y', yScale(d.name) + 4);
          });          
      }
    }

    function update_svg(data) {
        //d3.select("svg").remove();

        data.sort(function(a, b) {
                var x = a.population;
                var y = b.population;
                return y - x;
        });

        // SVG setup
        var margin = {top: 50, bottom: 10, left:300, right: 40};
        var width  = 2500 - margin.left - margin.right;
        var height = 2000 - margin.top - margin.bottom;
     
        var xScale = d3.scale.linear().range([0, width]);
        var yScale = d3.scale.ordinal().rangeRoundBands([0, data.length*15], .8, 0);
     
        var svg = d3.select("div.container").append("svg")
                     .attr("width", width+margin.left+margin.right)
                     .attr("height", height+margin.top+margin.bottom);
     
        var g = svg.append("g")
                    .attr("transform", "translate("+margin.left+","+margin.top+")");
     

 
        var max = d3.max(data, function(d) { return d.length; } );
        var min = 0;

        xScale.domain([min, max]);
        yScale.domain(data.map(function(d) { return d.name; }));
 
        var rows = g.append("g")
                    .selectAll("g.row")
                    .data(data)
                  .enter()
                    .append("g")
                    .attr("class", 'row' );


        var circle = rows
                    .append("circle")
                    .style("stroke", "black")
                    .style("fill", "white")                    
                    .attr("r", 4)
                    .attr("cx", 0)
                    .attr("cy", function(d) { return yScale(d.name); } );
        
        
          var text = rows
                      .append("text")
                      .attr("x", 20)
                      .attr("y", function(d) { return yScale(d.name) + 4; })
                      .attr("font-size", "10px")
                      .attr("font-family", "sans-serif")
                      .text(function (d) { return d.name; }); 
        
    }
  </script>



</body>
</html>